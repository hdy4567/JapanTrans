<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ì¼ë³¸ì–´ ë²ˆì—­ ì‹œë®¬ë ˆì´í„°</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }
        /* ë¶™ì—¬ë„£ê¸° ëŒ€ìƒ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        #pasteArea {
            border: 2px dashed #a5b4fc; /* indigo-300 */
            background-color: #f5f3ff; /* indigo-50 */
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        #pasteArea.active {
            border-color: #4f46e5; /* indigo-600 */
            background-color: #eef2ff; /* indigo-100 */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <!-- ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨í…Œì´ë„ˆ -->
    <div id="appContainer" class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100">

        <h1 class="text-3xl font-bold text-gray-800 mb-3 text-center">ìŠ¤í¬ë¦° ë²ˆì—­ í”„ë¡œí† íƒ€ì… ğŸ‡¯ğŸ‡µ â†’ ğŸ‡°ğŸ‡·</h1>
        <p class="text-center text-sm text-red-600 font-semibold mb-6 p-2 bg-red-50 rounded-lg">
            âš ï¸ ì´ ì•±ì€ ì›¹ í™˜ê²½ì˜ ë³´ì•ˆ ì œì•½ìœ¼ë¡œ ì¸í•´ ì‹¤ì œ 'ì‹¤ì‹œê°„ í™”ë©´ ìº¡ì²˜ ë° ëŒ€ì²´'ëŠ” ë¶ˆê°€ëŠ¥í•˜ë©°, **í´ë¦½ë³´ë“œ ì´ë¯¸ì§€** ë˜ëŠ” í…ìŠ¤íŠ¸ ì…ë ¥ ê¸°ë°˜ ë²ˆì—­ í”„ë¡œí† íƒ€ì…ì…ë‹ˆë‹¤.
        </p>
        <p class="text-center text-gray-600 mb-8">
            Windows ìº¡ì²˜ ë„êµ¬(`Win + Shift + S`)ë¡œ ì˜ì—­ì„ ë³µì‚¬í•œ í›„, ì•„ë˜ ì˜ì—­ì— ë°”ë¡œ **ë¶™ì—¬ë„£ê¸°(`Ctrl+V`)** í•˜ì„¸ìš”.
        </p>

        <!-- ì…ë ¥ ì„¹ì…˜ -->
        <div class="space-y-6">
            <div class="flex flex-col space-y-4 md:flex-row md:space-x-4 md:space-y-0">
                
                <!-- ì´ë¯¸ì§€ ì…ë ¥ (í´ë¦½ë³´ë“œ/ìŠ¤í¬ë¦°ìƒ· ì‹œë®¬ë ˆì´ì…˜) -->
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">1. í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° (Ctrl+V)</label>
                    <div id="pasteArea" class="rounded-lg p-4">
                        <span id="pasteHint" class="text-indigo-600 font-semibold">ì´ ì˜ì—­ì— ìº¡ì²˜ ì´ë¯¸ì§€ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</span>
                    </div>
                    <!-- (ê¸°ì¡´ì˜ File Inputì€ ìˆ¨ê¹€ ì²˜ë¦¬) -->
                    <input type="file" id="imageInput" accept="image/*" class="hidden" />
                </div>
                
                <!-- í…ìŠ¤íŠ¸ ì§ì ‘ ì…ë ¥ -->
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">2. ë˜ëŠ” ì¼ë³¸ì–´ ì§ì ‘ ì…ë ¥</label>
                    <textarea id="textInput" rows="4" placeholder="ä¾‹: ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆã§ã™ã€‚ (ì˜ˆ: ì´ê²ƒì€ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"></textarea>
                </div>
            </div>
            
            <!-- ì‹¤í–‰ ë²„íŠ¼ -->
            <button id="runButton" onclick="processTranslation()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-[1.01] flex items-center justify-center disabled:opacity-50" disabled>
                <span id="buttonText">ë²ˆì—­ ì‹œì‘</span>
                <svg id="loadingSpinner" class="hidden w-5 h-5 ml-2 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>

        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <div id="resultsSection" class="mt-10 pt-8 border-t border-gray-200 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">ë²ˆì—­ ê²°ê³¼</h2>

            <!-- OCR / ì›ë³¸ í…ìŠ¤íŠ¸ -->
            <div class="bg-indigo-50 p-5 rounded-xl mb-6">
                <h3 class="text-lg font-medium text-indigo-800 mb-2">3. ì›ë³¸(ì¼ë³¸ì–´) í…ìŠ¤íŠ¸ ì¶”ì¶œ/ì…ë ¥</h3>
                <p id="originalText" class="text-indigo-900 whitespace-pre-wrap break-words"></p>
            </div>
            
            <!-- ë²ˆì—­ëœ í•œêµ­ì–´ -->
            <div class="bg-green-50 p-5 rounded-xl shadow-inner">
                <h3 class="text-lg font-medium text-green-800 mb-2">4. í•œêµ­ì–´ ë²ˆì—­ ê²°ê³¼ (ëŒ€ì²´ ì˜ì—­ ì‹œë®¬ë ˆì´ì…˜)</h3>
                <p id="translatedText" class="text-green-900 font-bold text-xl whitespace-pre-wrap break-words"></p>
            </div>
            
             <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
             <div id="imagePreviewContainer" class="mt-6 hidden">
                <h3 class="text-lg font-medium text-gray-700 mb-2">í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (ìš©ëŸ‰ ìµœì†Œí™”ë¥¼ ìœ„í•´ ì„ì‹œ í‘œì‹œ)</h3>
                <img id="imagePreview" class="max-w-full h-auto rounded-lg border border-gray-300 shadow-md mx-auto" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" />
            </div>
        </div>
        
    </div>

    <script type="module">
        // Gemini API í˜¸ì¶œì— ì‚¬ìš©ë  URL. API í‚¤ëŠ” ì´ ì‹¤í–‰ í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        // ì „ì—­ DOM ìš”ì†Œ ì°¸ì¡°
        const textInput = document.getElementById('textInput');
        const runButton = document.getElementById('runButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultsSection = document.getElementById('resultsSection');
        const originalTextDisplay = document.getElementById('originalText');
        const translatedTextDisplay = document.getElementById('translatedText');
        const imagePreview = document.getElementById('imagePreview');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const pasteArea = document.getElementById('pasteArea');
        const pasteHint = document.getElementById('pasteHint');

        // ìƒíƒœ ê´€ë¦¬
        let isProcessing = false;
        let imageBlob = null; // í´ë¦½ë³´ë“œì—ì„œ ë¶™ì—¬ë„£ì€ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ì €ì¥
        const MAX_IMAGE_SIZE_MB = 10; // ìµœëŒ€ ì´ë¯¸ì§€ í¬ê¸° ì œí•œ (10MB)

        // --- UI í™œì„±í™”/ë¹„í™œì„±í™” ë° ìƒíƒœ ê´€ë¦¬ ---
        function updateButtonState() {
            const hasImage = imageBlob !== null;
            const hasText = textInput.value.trim().length > 0;
            const canRun = (hasImage || hasText) && !isProcessing;
            
            runButton.disabled = !canRun;
            if (!isProcessing) {
                buttonText.textContent = 'ë²ˆì—­ ì‹œì‘';
                loadingSpinner.classList.add('hidden');
            } else {
                loadingSpinner.classList.remove('hidden');
            }
        }
        
        // í…ìŠ¤íŠ¸ ì…ë ¥ ê°ì§€
        textInput.addEventListener('input', () => {
            // í…ìŠ¤íŠ¸ ì…ë ¥ ì‹œ ì´ë¯¸ì§€ ì…ë ¥(ë¶™ì—¬ë„£ê¸°) ìƒíƒœ ì´ˆê¸°í™”
            if (textInput.value.trim().length > 0) {
                imageBlob = null;
                imagePreviewContainer.classList.add('hidden');
                pasteHint.textContent = "í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì—¬ ì´ë¯¸ì§€ëŠ” ë¹„í™œì„±í™”ë¨";
                pasteArea.classList.add('active'); // í™œì„±í™” ìƒíƒœ ìœ ì§€ì²˜ëŸ¼ ë³´ì„
            } else {
                pasteHint.textContent = "ì´ ì˜ì—­ì— ìº¡ì²˜ ì´ë¯¸ì§€ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.";
                pasteArea.classList.remove('active');
            }
            updateButtonState();
        });

        // --- í´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
        document.addEventListener('paste', function(event) {
            // í…ìŠ¤íŠ¸ ì…ë ¥ë€ì´ ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ ë¶™ì—¬ë„£ê¸° ë¬´ì‹œ
            if (textInput.value.trim().length > 0) return;

            const items = event.clipboardData.items;
            let foundImage = false;

            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    event.preventDefault(); // ê¸°ë³¸ ë¶™ì—¬ë„£ê¸° ë™ì‘ ë°©ì§€
                    const file = items[i].getAsFile();

                    if (file.size > MAX_IMAGE_SIZE_MB * 1024 * 1024) {
                        alert(`ì´ë¯¸ì§€ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ${MAX_IMAGE_SIZE_MB}MB ì´í•˜ì˜ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.`);
                        continue;
                    }

                    imageBlob = file; // ì´ë¯¸ì§€ ë°ì´í„° ì €ì¥
                    foundImage = true;
                    
                    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (ìš©ëŸ‰ ìµœì†Œí™”ë¥¼ ìœ„í•œ ì„ì‹œ í‘œì‹œ)
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreviewContainer.classList.remove('hidden');
                        pasteArea.classList.add('active');
                        pasteHint.textContent = "ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì™„ë£Œ! ì•„ë˜ 'ë²ˆì—­ ì‹œì‘' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.";
                        updateButtonState();
                    };
                    reader.readAsDataURL(file);
                    break;
                }
            }

            if (!foundImage && imageBlob === null) {
                 pasteHint.textContent = "ì´ë¯¸ì§€ê°€ í´ë¦½ë³´ë“œì—ì„œ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìº¡ì²˜ í›„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.";
            }
        });

        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        updateButtonState();


        // --- Tesseract OCR í•¨ìˆ˜ (ì¼ë³¸ì–´ ì¸ì‹) ---
        async function runOCR(imageFile) {
            buttonText.textContent = "OCR ì§„í–‰ ì¤‘...";
            console.log("OCR ì‹œì‘...");
            
            try {
                // Tesseract worker ìƒì„± ë° ì¼ë³¸ì–´(jpn) ë¡œë“œ
                const worker = await Tesseract.createWorker('jpn');

                const { data: { text } } = await worker.recognize(imageFile);
                
                await worker.terminate();
                
                console.log("OCR ê²°ê³¼:", text);
                return text.trim();
                
            } catch (error) {
                console.error("Tesseract OCR ì˜¤ë¥˜:", error);
                throw new Error("OCR ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ íŒŒì¼ì´ ìœ íš¨í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
        }

        // --- Gemini API í˜¸ì¶œ í•¨ìˆ˜ (ë²ˆì—­) ---
        async function translateText(japaneseText) {
            buttonText.textContent = "ë²ˆì—­ ì§„í–‰ ì¤‘...";
            console.log("Gemini API ë²ˆì—­ ì‹œì‘...");
            
            const systemPrompt = "ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ ì¼ë³¸ì–´-í•œêµ­ì–´ ë²ˆì—­ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ì¼ë³¸ì–´ í…ìŠ¤íŠ¸ë¥¼ ê°€ì¥ ìì—°ìŠ¤ëŸ½ê³  ì •í™•í•˜ë©°, ê²©ì‹ì— ë§ëŠ” í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ì„¸ìš”. ë²ˆì—­ëœ í•œêµ­ì–´ í…ìŠ¤íŠ¸ë§Œ ì¶œë ¥í•´ì•¼ í•˜ë©°, ì–´ë– í•œ ì„¤ëª…ì´ë‚˜ ì¶”ê°€ ë¬¸ì¥ë„ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.";
            
            const payload = {
                contents: [{ parts: [{ text: `ë²ˆì—­í•  ì¼ë³¸ì–´ í…ìŠ¤íŠ¸: ${japaneseText}` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let maxRetries = 3;
            let delay = 1000;
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            const translated = candidate.content.parts[0].text.trim();
                            console.log("ë²ˆì—­ ê²°ê³¼:", translated);
                            return translated;
                        } else {
                            throw new Error("Gemini APIì—ì„œ ìœ íš¨í•œ í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                        }
                    } else if (response.status === 429 && i < maxRetries - 1) {
                        console.warn(`API ì œí•œ: ${delay}ms í›„ ì¬ì‹œë„...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // ì§€ì—° ì‹œê°„ ì¦ê°€ (Exponential Backoff)
                    } else {
                        const errorBody = await response.text();
                        throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status} - ${errorBody}`);
                    }
                } catch (error) {
                    console.error("Gemini API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                    if (i === maxRetries - 1) throw error; // ë§ˆì§€ë§‰ ì‹œë„ì—ì„œë§Œ ì—ëŸ¬ ë˜ì§€ê¸°
                }
            }
            throw new Error("API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }

        // --- ë©”ì¸ ì²˜ë¦¬ ë¡œì§ ---
        window.processTranslation = async function() {
            if (isProcessing) return;
            isProcessing = true;
            
            originalTextDisplay.textContent = 'ì²˜ë¦¬ ì¤‘...';
            translatedTextDisplay.textContent = 'ì²˜ë¦¬ ì¤‘...';
            resultsSection.classList.remove('hidden');
            updateButtonState();

            try {
                let japaneseText = '';
                const inputTextBox = textInput.value.trim();

                if (imageBlob) {
                    // í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ì¸ ê²½ìš° OCR ìˆ˜í–‰
                    japaneseText = await runOCR(imageBlob);
                    if (!japaneseText) {
                        throw new Error("ì´ë¯¸ì§€ì—ì„œ ì¼ë³¸ì–´ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë” ì„ ëª…í•œ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”.");
                    }

                } else if (inputTextBox) {
                    // í…ìŠ¤íŠ¸ ì§ì ‘ ì…ë ¥ì¸ ê²½ìš°
                    japaneseText = inputTextBox;
                    imagePreviewContainer.classList.add('hidden');
                } else {
                    // ì´ ê²½ë¡œëŠ” runButton.disabled ë•Œë¬¸ì— ë„ë‹¬í•˜ì§€ ì•Šì•„ì•¼ í•˜ì§€ë§Œ, ì•ˆì „ì„ ìœ„í•´ ì¶”ê°€
                    throw new Error("ì´ë¯¸ì§€ë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜ ì¼ë³¸ì–´ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
                }

                // OCR/ì…ë ¥ëœ í…ìŠ¤íŠ¸ í‘œì‹œ
                originalTextDisplay.textContent = japaneseText;

                // ë²ˆì—­ ìˆ˜í–‰
                const koreanTranslation = await translateText(japaneseText);
                
                // ê²°ê³¼ í‘œì‹œ
                translatedTextDisplay.textContent = koreanTranslation;

            } catch (error) {
                console.error("ìµœì¢… ì²˜ë¦¬ ì˜¤ë¥˜:", error);
                const errorMessage = error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                
                // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©ìì—ê²Œ í‘œì‹œ
                originalTextDisplay.textContent = `âŒ ì˜¤ë¥˜ ë°œìƒ: ${errorMessage}`;
                translatedTextDisplay.textContent = 'ë²ˆì—­ì„ ì™„ë£Œí•  ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.';
                
            } finally {
                isProcessing = false;
                updateButtonState();
            }
        }
    </script>
</body>
</html>